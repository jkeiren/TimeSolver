# Flags passed to the C compiler.
CFLAGS = -c -g -O -Wall

# Flags passed to the C++ compiler.
CXXFLAGS += -g -Wall -Wextra

# Stack size set to 4GB for Mac, since terminal hard limit is 64MB
# My machine has 16GB of RAM
# This number is the number of bytes in Hex
SFLAGS = -Wl,-stack_size,200000000
FLEX = flex

LDFLAGS =  
INCL_PATH = -I.

TEST_DIR = test

.PHONY: default
default: all

all: demo testdbmlist check

doc: demo *.hh *.cc
	doxygen pes-timed_Doxyfile

demo:	pes.tab.o pes.lex.o ExprNode.o demo.o
	$(CXX) -o demo pes.lex.o pes.tab.o ExprNode.o demo.o $(SFLAGS) $(LDFLAGS) 

demo.o: demo.cc DBM.hh ExprNode.hh DBMList.hh
	$(CXX) $(CFLAGS) demo.cc $(INCL_PATH)

ExprNode.o: ExprNode.cc ExprNode.hh DBM.hh
	$(CXX) $(CFLAGS) ExprNode.cc $(INCL_PATH)

pes.lex.o: pes.lex.cc
	$(CXX) $(CFLAGS) pes.lex.cc $(INCL_PATH) 

pes.lex.cc: pes.l
	$(FLEX) -p -8 -Ce -opes.lex.cc pes.l

pes.tab.o: pes.tab.cc DBM.hh ExprNode.hh
	$(CXX) $(CFLAGS) pes.tab.cc $(INCL_PATH)

pes.tab.cc: pes.y
	bison -t -d -v -o pes.tab.cc pes.y

check:
	$(MAKE) -C $(TEST_DIR)

testdbmlist: testdbmlist.cc DBMList.hh DBM.hh
	$(CXX) -o testdbmlist -g testdbmlist.cc
 
clean:
	-echo "Removing all object files!"
	-rm -f demo *.o
	-rm -f testdbmlist
	-echo "Removing intermediate C++ files!"
	-rm -f pes.lex.cc pes.tab.cc
	-echo "Removing intermediate header files!"
	-rm -f pes.tab.hh
	-echo "Removing other parser-generated files!"
	-rm -f pes.output
	-echo "Removing Doxygen-generated documentation files!"
	-rm -rf doc/DoxygenOutput/html
	-rm -rf doc/DoxygenOutput/latex
	-echo "Removing other tool-generated files!"
	-rm -rf testdbmlist.dSYM
	-rm -rf demo.dSYM
	-rm -f gmon.out
	$(MAKE) -C $(TEST_DIR) clean
